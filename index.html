<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>MindfulSpace Pro | Ultimate Edition</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
:root {
  --bg-deep: #050510;
  --accent-primary: #00f2ff;
  --accent-secondary: #ff0055;
  --glass-bg: rgba(20, 20, 35, 0.65);
  --glass-border: rgba(255, 255, 255, 0.08);
  --text-main: #ffffff;
  --text-muted: #a0a0b0;
  --shadow-card: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
  --neon-glow: 0 0 20px rgba(0, 242, 255, 0.15);
}

* { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
body {
  margin: 0; padding: 0;
  background-color: var(--bg-deep);
  background-image: 
    radial-gradient(circle at 15% 50%, rgba(76, 29, 149, 0.15) 0%, transparent 50%),
    radial-gradient(circle at 85% 30%, rgba(255, 0, 85, 0.1) 0%, transparent 50%);
  font-family: 'Tajawal', sans-serif;
  overflow: hidden; /* Hide scrollbars, custom canvas handles it */
  color: var(--text-main);
  height: 100vh;
  width: 100vw;
  user-select: none;
}

/* --- UI Controls --- */
.ui-layer {
  position: fixed; z-index: 1000;
  pointer-events: none; /* Let clicks pass through empty areas */
  width: 100%; height: 100%; top: 0; left: 0;
  display: flex; flex-direction: column; justify-content: space-between;
  padding: 20px;
}

.navbar {
  pointer-events: auto;
  display: flex; justify-content: space-between; align-items: center;
  background: rgba(10, 10, 20, 0.8);
  backdrop-filter: blur(15px);
  padding: 10px 20px;
  border-radius: 16px;
  border: 1px solid var(--glass-border);
  box-shadow: 0 4px 20px rgba(0,0,0,0.3);
  align-self: center;
  max-width: 900px;
  width: 100%;
  animation: slideDown 0.6s cubic-bezier(0.16, 1, 0.3, 1);
}

.brand { display: flex; align-items: center; gap: 12px; }
.brand i { font-size: 1.5rem; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
.brand span { font-weight: 700; font-size: 1.2rem; letter-spacing: 1px; }

.tools { display: flex; gap: 10px; }
.tool-btn {
  background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border);
  color: var(--text-main); width: 40px; height: 40px; border-radius: 10px;
  cursor: pointer; transition: all 0.2s ease; display: grid; place-items: center;
  font-size: 1rem;
}
.tool-btn:hover { background: rgba(255,255,255,0.15); transform: translateY(-2px); color: var(--accent-primary); }

/* --- FAB Menu --- */
.fab-wrapper {
  pointer-events: auto;
  position: absolute; bottom: 30px; left: 30px;
  display: flex; flex-direction: column-reverse; gap: 12px; align-items: flex-start;
}

.fab-main {
  width: 60px; height: 60px; border-radius: 50%;
  background: linear-gradient(135deg, var(--accent-primary), #00c3ff);
  border: none; color: #000; font-size: 1.5rem;
  box-shadow: 0 0 20px rgba(0, 242, 255, 0.4);
  cursor: pointer; transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
  display: grid; place-items: center;
}
.fab-main:hover { transform: scale(1.1) rotate(90deg); }
.fab-main.active { transform: rotate(45deg); background: var(--accent-secondary); box-shadow: 0 0 20px rgba(255, 0, 85, 0.4); }

.fab-options {
  display: flex; flex-direction: column; gap: 10px;
  opacity: 0; transform: translateY(20px) scale(0.8);
  pointer-events: none; transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
}
.fab-wrapper.open .fab-options { opacity: 1; transform: translateY(0) scale(1); pointer-events: auto; }

.fab-item {
  background: var(--glass-bg); backdrop-filter: blur(10px);
  border: 1px solid var(--glass-border); color: #fff;
  padding: 10px 20px; border-radius: 30px;
  cursor: pointer; display: flex; align-items: center; gap: 8px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.2);
  font-size: 0.9rem; white-space: nowrap;
}
.fab-item i { color: var(--accent-primary); }
.fab-item:hover { background: rgba(255,255,255,0.1); transform: translateX(-5px); }

/* --- Infinite Canvas --- */
#viewport {
  width: 100vw; height: 100vh; overflow: hidden; cursor: grab;
  background-image: 
    linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px),
    linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px);
  background-size: 50px 50px; /* Grid Size */
}
#viewport:active { cursor: grabbing; }

#world {
  position: absolute; top: 0; left: 0;
  transform-origin: 0 0;
  width: 0; height: 0; /* Expansion point */
  will-change: transform;
}

/* --- Items (Notes & Widgets) --- */
.item {
  position: absolute;
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
  padding: 0; /* Padding managed inside */
  box-shadow: var(--shadow-card);
  min-width: 240px;
  max-width: 350px;
  display: flex; flex-direction: column;
  transition: box-shadow 0.2s, border-color 0.2s;
  overflow: hidden;
  animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  user-select: text; /* Allow text selection inside */
}

.item:hover,.item.active {
  border-color: rgba(255,255,255,0.2);
  box-shadow: 0 15px 40px rgba(0,0,0,0.6);
  z-index: 999; /* Bring to front */
}

.item-header {
  padding: 12px 15px;
  background: rgba(0,0,0,0.2);
  cursor: grab; /* Drag handle */
  display: flex; justify-content: space-between; align-items: center;
  border-bottom: 1px solid var(--glass-border);
  font-size: 0.9rem; color: var(--text-muted); font-weight: 600;
}
.item-header:active { cursor: grabbing; }
.item-actions { opacity: 0; transition: opacity 0.2s; display: flex; gap: 8px; }
.item:hover .item-actions { opacity: 1; }
.action-icon { cursor: pointer; padding: 4px; border-radius: 4px; transition: 0.2s; }
.action-icon:hover { background: rgba(255,255,255,0.1); color: #fff; }

.item-body {
  padding: 15px;
  flex: 1; min-height: 100px;
  font-size: 1rem; line-height: 1.6; color: var(--text-main);
}
.item-body[contenteditable]:empty:before {
  content: 'ÿßŸÉÿ™ÿ® ÿ¥Ÿäÿ¶ÿßŸã ÿ±ÿßÿ¶ÿπÿßŸã...';
  color: rgba(255,255,255,0.3);
}

/* --- Specific Widget Styles --- */
.todo-item {
  display: flex; align-items: center; gap: 10px; margin-bottom: 8px;
  padding: 8px; background: rgba(255,255,255,0.03); border-radius: 8px;
  transition: 0.2s;
}
.todo-item:hover { background: rgba(255,255,255,0.06); }
.todo-item.completed span { text-decoration: line-through; opacity: 0.5; }
.todo-check {
  appearance: none; width: 18px; height: 18px; border: 2px solid var(--accent-primary);
  border-radius: 4px; cursor: pointer; position: relative;
}
.todo-check:checked { background: var(--accent-primary); }
.todo-check:checked::after {
  content: '‚úî'; position: absolute; top: -3px; left: 2px; font-size: 12px; color: #000;
}

.timer-display { font-size: 2.5rem; font-family: monospace; text-align: center; margin: 10px 0; color: var(--accent-primary); text-shadow: 0 0 10px var(--accent-primary); }
.timer-controls { display: flex; justify-content: center; gap: 10px; }
.btn-sm { padding: 5px 15px; border-radius: 6px; border: 1px solid var(--glass-border); background: rgba(255,255,255,0.1); color: #fff; cursor: pointer; }
.btn-sm:hover { background: var(--accent-primary); color: #000; }

/* --- Animations --- */
@keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
@keyframes slideDown { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

/* Helper for resize handle */
.resize-handle {
  width: 15px; height: 15px; position: absolute; bottom: 0; left: 0;
  cursor: nwse-resize; opacity: 0.3; transition: 0.2s;
}
.resize-handle:hover { opacity: 1; background: var(--accent-primary); }

</style>
</head>
<body>

<div class="ui-layer">
  <div class="navbar">
    <div class="brand">
      <i class="fa-solid fa-brain"></i>
      <span>MindfulSpace Pro</span>
    </div>
    <div class="tools">
      <div class="tool-btn" onclick="resetView()" title="ÿ•ÿπÿßÿØÿ© ÿ∂ÿ®ÿ∑ ÿßŸÑÿπÿ±ÿ∂"><i class="fa-solid fa-compress"></i></div>
      <div class="tool-btn" onclick="exportData()" title="ÿ™ÿµÿØŸäÿ± ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™"><i class="fa-solid fa-download"></i></div>
      <div class="tool-btn" onclick="clearCanvas()" title="ŸÖÿ≥ÿ≠ ÿßŸÑŸÉŸÑ" style="color:var(--accent-secondary)"><i class="fa-solid fa-trash"></i></div>
    </div>
  </div>

  <div class="fab-wrapper" id="fabWrapper">
    <button class="fab-main" id="fabBtn"><i class="fa-solid fa-plus"></i></button>
    <div class="fab-options">
      <div class="fab-item" onclick="createItem('note')"><i class="fa-regular fa-note-sticky"></i> ŸÖŸÑÿßÿ≠ÿ∏ÿ© ÿ¨ÿØŸäÿØÿ©</div>
      <div class="fab-item" onclick="createItem('todo')"><i class="fa-solid fa-list-check"></i> ŸÇÿßÿ¶ŸÖÿ© ŸÖŸáÿßŸÖ</div>
      <div class="fab-item" onclick="createItem('pomodoro')"><i class="fa-solid fa-clock"></i> ÿ®ŸàŸÖŸàÿØŸàÿ±Ÿà</div>
      <div class="fab-item" onclick="createItem('stopwatch')"><i class="fa-solid fa-stopwatch"></i> ÿ≥ÿßÿπÿ© ÿ•ŸäŸÇÿßŸÅ</div>
    </div>
  </div>
</div>

<div id="viewport">
  <div id="world">
    <!-- Items injected via JS -->
  </div>
</div>

<script>
// --- State Management ---
const state = {
  items: JSON.parse(localStorage.getItem('mindful_items') || '[]'),
  view: JSON.parse(localStorage.getItem('mindful_view') || '{"x":0,"y":0,"scale":1}'),
  nextId: Date.now()
};

// --- DOM Elements ---
const world = document.getElementById('world');
const viewport = document.getElementById('viewport');
const fabBtn = document.getElementById('fabBtn');
const fabWrapper = document.getElementById('fabWrapper');

// --- Init ---
function init() {
  applyView();
  state.items.forEach(renderItem);
  
  // Start timers if any exist
  setInterval(updateTimers, 1000);
  
  // Auto-save interval
  setInterval(saveState, 2000);
}

// --- Canvas Logic (Pan & Zoom) ---
let isPanning = false;
let startX, startY, initialViewX, initialViewY;

viewport.addEventListener('mousedown', (e) => {
  if(e.target === viewport || e.target === world) {
    isPanning = true;
    startX = e.clientX;
    startY = e.clientY;
    initialViewX = state.view.x;
    initialViewY = state.view.y;
    viewport.style.cursor = 'grabbing';
  }
});

window.addEventListener('mousemove', (e) => {
  if (!isPanning) return;
  const dx = (e.clientX - startX);
  const dy = (e.clientY - startY);
  state.view.x = initialViewX + dx;
  state.view.y = initialViewY + dy;
  applyView();
});

window.addEventListener('mouseup', () => {
  isPanning = false;
  viewport.style.cursor = 'grab';
});

viewport.addEventListener('wheel', (e) => {
  e.preventDefault();
  const zoomSensitivity = 0.001;
  const delta = -e.deltaY * zoomSensitivity;
  const newScale = Math.min(Math.max(0.2, state.view.scale + delta), 3);
  
  // Zoom towards center (simplified)
  state.view.scale = newScale;
  applyView();
}, { passive: false });

function applyView() {
  world.style.transform = `translate(${state.view.x}px, ${state.view.y}px) scale(${state.view.scale})`;
  localStorage.setItem('mindful_view', JSON.stringify(state.view));
}

function resetView() {
  state.view = { x: 0, y: 0, scale: 1 };
  applyView();
}

// --- Item Factory ---
function createItem(type) {
  // Random position near center of current view
  const centerX = (-state.view.x + window.innerWidth/2) / state.view.scale;
  const centerY = (-state.view.y + window.innerHeight/2) / state.view.scale;
  const randomOffset = (Math.random() - 0.5) * 100;

  const item = {
    id: state.nextId++,
    type: type,
    x: centerX + randomOffset - 150,
    y: centerY + randomOffset - 100,
    content: '',
    title: type === 'note' ? 'ŸÅŸÉÿ±ÿ© ÿ¨ÿØŸäÿØÿ©' : (type === 'todo' ? 'ÿßŸÑŸÖŸáÿßŸÖ' : 'ÿßŸÑŸÖÿ§ŸÇÿ™'),
    color: 'default',
    data: type === 'todo' ? [] : (type === 'pomodoro' ? { time: 25 * 60, active: false } : { time: 0, active: false })
  };
  
  state.items.push(item);
  renderItem(item);
  toggleFab();
  saveState();
}

// --- Rendering ---
function renderItem(itemData) {
  const el = document.createElement('div');
  el.className = 'item';
  el.id = `item-${itemData.id}`;
  el.style.transform = `translate(${itemData.x}px, ${itemData.y}px)`;
  
  // Header
  const header = document.createElement('div');
  header.className = 'item-header';
  header.innerHTML = `
    <span>${itemData.title}</span>
    <div class="item-actions">
      <i class="fa-solid fa-xmark action-icon" onclick="deleteItem(${itemData.id})"></i>
    </div>
  `;
  
  // Body based on type
  const body = document.createElement('div');
  body.className = 'item-body';
  
  if (itemData.type === 'note') {
    body.contentEditable = true;
    body.innerHTML = itemData.content;
    body.oninput = () => { itemData.content = body.innerHTML; saveState(); };
  } 
  else if (itemData.type === 'todo') {
    const addBtn = document.createElement('button');
    addBtn.className = 'btn-sm';
    addBtn.innerText = '+ ÿ•ÿ∂ÿßŸÅÿ©';
    addBtn.style.width = '100%';
    addBtn.style.marginTop = '10px';
    addBtn.onclick = () => {
      const text = prompt('ÿßŸÑŸÖŸáŸÖÿ©:');
      if(text) {
        itemData.data.push({ text, done: false });
        renderTodos(body, itemData);
        saveState();
      }
    };
    body.appendChild(addBtn);
    renderTodos(body, itemData);
  }
  else if (itemData.type === 'pomodoro') {
    body.innerHTML = `
      <div class="timer-display" id="timer-${itemData.id}">25:00</div>
      <div class="timer-controls">
        <button class="btn-sm" onclick="toggleTimer(${itemData.id}, 'pomodoro')"><i class="fa-solid fa-play"></i></button>
        <button class="btn-sm" onclick="resetTimer(${itemData.id}, 'pomodoro')"><i class="fa-solid fa-rotate-right"></i></button>
      </div>
      <div style="text-align:center; margin-top:5px; font-size:0.8rem; opacity:0.7;">Ÿàÿ∂ÿπ ÿßŸÑÿ™ÿ±ŸÉŸäÿ≤</div>
    `;
  }
  else if (itemData.type === 'stopwatch') {
    body.innerHTML = `
      <div class="timer-display" id="timer-${itemData.id}" style="color:var(--accent-secondary)">00:00</div>
      <div class="timer-controls">
        <button class="btn-sm" onclick="toggleTimer(${itemData.id}, 'stopwatch')"><i class="fa-solid fa-play"></i></button>
        <button class="btn-sm" onclick="resetTimer(${itemData.id}, 'stopwatch')"><i class="fa-solid fa-rotate-right"></i></button>
      </div>
    `;
  }

  el.appendChild(header);
  el.appendChild(body);
  world.appendChild(el);

  // Drag Logic for Items
  setupDrag(el, itemData);
  
  // Z-Index Logic
  el.addEventListener('mousedown', () => {
    document.querySelectorAll('.item').forEach(i => i.classList.remove('active'));
    el.classList.add('active');
  });
}

function renderTodos(container, itemData) {
  // Clear existing except add button (last child)
  while(container.children.length > 1) {
    container.removeChild(container.firstChild);
  }
  
  itemData.data.forEach((todo, idx) => {
    const div = document.createElement('div');
    div.className = `todo-item ${todo.done ? 'completed' : ''}`;
    div.innerHTML = `
      <input type="checkbox" class="todo-check" ${todo.done ? 'checked' : ''}>
      <span style="flex:1">${todo.text}</span>
      <i class="fa-solid fa-trash" style="cursor:pointer; opacity:0.5; font-size:0.8rem" onclick="deleteTodo(${itemData.id}, ${idx})"></i>
    `;
    
    div.querySelector('input').onchange = (e) => {
      todo.done = e.target.checked;
      div.classList.toggle('completed');
      saveState();
    };
    
    container.insertBefore(div, container.lastChild);
  });
}

function deleteTodo(itemId, todoIdx) {
  const item = state.items.find(i => i.id === itemId);
  item.data.splice(todoIdx, 1);
  // Re-render
  const container = document.querySelector(`#item-${itemId} .item-body`);
  renderTodos(container, item);
  saveState();
}

// --- Drag & Drop Logic (Items) ---
function setupDrag(el, itemData) {
  const header = el.querySelector('.item-header');
  let isDragging = false, dragStartX, dragStartY, initX, initY;

  header.addEventListener('mousedown', (e) => {
    isDragging = true;
    dragStartX = e.clientX;
    dragStartY = e.clientY;
    initX = itemData.x;
    initY = itemData.y;
    el.style.transition = 'none'; // Disable transition for direct follow
  });

  window.addEventListener('mousemove', (e) => {
    if (!isDragging) return;
    // Calculate delta adjusted by current zoom scale
    const dx = (e.clientX - dragStartX) / state.view.scale;
    const dy = (e.clientY - dragStartY) / state.view.scale;
    
    itemData.x = initX + dx;
    itemData.y = initY + dy;
    el.style.transform = `translate(${itemData.x}px, ${itemData.y}px)`;
  });

  window.addEventListener('mouseup', () => {
    if(isDragging) {
      isDragging = false;
      el.style.transition = ''; // Re-enable transition
      saveState();
    }
  });
}

// --- Timer Logic ---
function updateTimers() {
  state.items.forEach(item => {
    if (item.type === 'pomodoro' || item.type === 'stopwatch') {
      if (item.data.active) {
        if(item.type === 'stopwatch') item.data.time++;
        else if (item.data.time > 0) item.data.time--;
        
        updateTimerDisplay(item.id, item.data.time, item.type);
        saveState(); // Save every second (could be optimized)
      }
    }
  });
}

function updateTimerDisplay(id, seconds, type) {
  const display = document.getElementById(`timer-${id}`);
  if (!display) return;
  
  const m = Math.floor(seconds / 60);
  const s = seconds % 60;
  const text = `${m}:${s < 10 ? '0' : ''}${s}`;
  
  if(type === 'pomodoro' && seconds === 0) {
     item = state.items.find(i => i.id === id);
     if(item) { item.data.active = false; alert("ÿßŸÜÿ™ŸáŸâ ÿßŸÑŸàŸÇÿ™! üçÖ"); }
  }
  
  display.innerText = text;
}

function toggleTimer(id, type) {
  const item = state.items.find(i => i.id === id);
  item.data.active = !item.data.active;
  const icon = document.querySelector(`#item-${id} .fa-play`);
  icon.className = item.data.active ? 'fa-solid fa-pause' : 'fa-solid fa-play';
  saveState();
}

function resetTimer(id, type) {
  const item = state.items.find(i => i.id === id);
  item.data.active = false;
  item.data.time = type === 'pomodoro' ? 25 * 60 : 0;
  updateTimerDisplay(id, item.data.time, type);
  document.querySelector(`#item-${id} .fa-play`).className = 'fa-solid fa-play';
  saveState();
}

// --- Utilities ---
function toggleFab() {
  fabWrapper.classList.toggle('open');
  fabBtn.classList.toggle('active');
}

fabBtn.addEventListener('click', toggleFab);

function deleteItem(id) {
  if(confirm('ÿ≠ÿ∞ŸÅ Ÿáÿ∞ÿß ÿßŸÑÿπŸÜÿµÿ±ÿü')) {
    state.items = state.items.filter(i => i.id !== id);
    document.getElementById(`item-${id}`).remove();
    saveState();
  }
}

function clearCanvas() {
  if(confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ŸÖÿ≥ÿ≠ ŸÉŸÑ ÿ¥Ÿäÿ°ÿü ŸÑÿß ŸäŸÖŸÉŸÜ ÿßŸÑÿ™ÿ±ÿßÿ¨ÿπ!')) {
    state.items = [];
    world.innerHTML = '';
    saveState();
  }
}

function saveState() {
  localStorage.setItem('mindful_items', JSON.stringify(state.items));
}

function exportData() {
  const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state.items));
  const downloadAnchorNode = document.createElement('a');
  downloadAnchorNode.setAttribute("href", dataStr);
  downloadAnchorNode.setAttribute("download", "mindful_backup_" + Date.now() + ".json");
  document.body.appendChild(downloadAnchorNode);
  downloadAnchorNode.click();
  downloadAnchorNode.remove();
}

// Start
init();

</script>
</body>
</html>